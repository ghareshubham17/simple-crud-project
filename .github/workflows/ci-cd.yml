name: Spring MVC CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  # Enhanced Build and Test Job
  build-and-test:
    name: ğŸ—ï¸ Build and Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven  # Built-in Maven caching
    
    # Display project information
    - name: ğŸ“‹ Display Project Info
      run: |
        echo "ğŸš€ Starting CI/CD Pipeline for Spring MVC Application"
        echo "Java Version: $(java -version 2>&1 | head -1)"
        echo "Maven Version: $(mvn -version | head -1)"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
    
    # Validate Maven project
    - name: âœ… Validate Maven Project
      run: mvn validate
    
    # Compile the project
    - name: ğŸ”¨ Compile Project
      run: |
        echo "ğŸ“¦ Compiling Spring MVC application..."
        mvn clean compile -B
    
    # Run unit tests with detailed reporting
    - name: ğŸ§ª Run Unit Tests
      run: |
        echo "ğŸ” Running unit tests..."
        mvn test -B
      continue-on-error: false
    
    # Generate test reports
    - name: ğŸ“Š Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()  # Run even if tests fail
      with:
        name: 'Maven Test Results'
        path: 'target/surefire-reports/*.xml'
        reporter: 'java-junit'
        fail-on-error: true
    
    # Build the application package
    - name: ğŸ“¦ Build Application Package
      run: |
        echo "ğŸ—ï¸ Building application package..."
        mvn clean package -B -DskipTests
    
    # Display build artifacts
    - name: ğŸ“‹ List Build Artifacts
      run: |
        echo "ğŸ“¦ Generated artifacts:"
        find target -name "*.jar" -type f -exec ls -lah {} \;
        echo "ğŸ“ Target directory contents:"
        ls -la target/
    
    # Upload build artifacts
    - name: ğŸ“¤ Upload JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: spring-mvc-jar-${{ github.run_number }}
        path: target/*.jar
        retention-days: 30
    
    # Upload test reports
    - name: ğŸ“¤ Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ github.run_number }}
        path: |
          target/surefire-reports/
          target/site/jacoco/
        retention-days: 30

  # Code Quality Analysis
  code-quality:
    name: ğŸ” Code Quality Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ” Run Code Quality Checks
      run: |
        echo "ğŸ” Running code quality analysis..."
        mvn clean verify -B
        echo "âœ… Code quality checks completed"
    
    - name: ğŸ“Š Generate Code Coverage Report
      run: |
        mvn jacoco:report
        echo "ğŸ“Š Code coverage report generated"
    
    - name: ğŸ“¤ Upload Coverage Reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports-${{ github.run_number }}
        path: target/site/jacoco/
        retention-days: 30

  # Security Scanning
  security-scan:
    name: ğŸ”’ Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ”’ Run OWASP Dependency Check
      run: |
        echo "ğŸ”’ Running security vulnerability scan..."
        mvn org.owasp:dependency-check-maven:check -B || echo "Security scan completed with warnings"
    
    - name: ğŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports-${{ github.run_number }}
        path: target/dependency-check-report.html
        retention-days: 30

  # Performance Testing (Optional)
  performance-test:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Application JAR
      uses: actions/download-artifact@v4
      with:
        name: spring-mvc-jar-${{ github.run_number }}
        path: ./app
    
    - name: âš¡ Run Performance Tests
      run: |
        echo "âš¡ Starting performance testing..."
        echo "ğŸ“‹ Available JAR files:"
        ls -la app/
        echo "ğŸš€ Performance testing would run here"
        echo "ğŸ’¡ Consider adding JMeter or Gatling tests"

  # Deploy to Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: ğŸ“¥ Download Application JAR
      uses: actions/download-artifact@v4
      with:
        name: spring-mvc-jar-${{ github.run_number }}
        path: ./staging-deploy
    
    - name: ğŸš€ Deploy to Staging Environment
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "ğŸ“‹ Deployment artifacts:"
        ls -la staging-deploy/
        echo "ğŸ¯ Staging deployment completed successfully!"
        echo "ğŸŒ Application URL: https://staging.yourapp.com"

  # Deploy to Production
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, security-scan]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Download Application JAR
      uses: actions/download-artifact@v4
      with:
        name: spring-mvc-jar-${{ github.run_number }}
        path: ./production-deploy
    
    - name: ğŸŒŸ Deploy to Production Environment
      run: |
        echo "ğŸŒŸ Deploying to production environment..."
        echo "ğŸ“‹ Production deployment artifacts:"
        ls -la production-deploy/
        echo "âœ… Production deployment completed successfully!"
        echo "ğŸŒ Production URL: https://yourapp.com"

  # Notification Job
  notify-completion:
    name: ğŸ“¢ Pipeline Completion Notification
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always()
    
    steps:
    - name: ğŸ“¢ Send Pipeline Status Notification
      run: |
        echo "ğŸ“‹ Pipeline Execution Summary:"
        echo "ğŸ”— Repository: ${{ github.repository }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "â° Execution time: $(date)"
        
        if [ "${{ needs.deploy-production.result }}" == "success" ]; then
          echo "âœ… Production deployment: SUCCESS"
        elif [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          echo "âœ… Staging deployment: SUCCESS"
        else
          echo "â„¹ï¸ Deployment: SKIPPED (not main/master branch)"
        fi
        
        echo ""
        echo "ğŸ‰ CI/CD Pipeline completed!"
        echo "ğŸ“Š Check the Actions tab for detailed logs and artifacts"